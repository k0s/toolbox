Test toolbox JSON handling
==========================

Ensure we have no projects::

    >>> app.get('/')
    []

Make a project::

    >>> project = {'name': 'foo', 'description': 'foo description', 'url': 'http://example.com'}
    >>> response = app.post('/new', params=project)
    >>> response.status
    303
    >>> newproject = app.get('/')[0]
    >>> modified = newproject.pop('modified')
    >>> project == newproject
    True

Add some fields to it::

    >>> fields = {'author': 'jhammel'}
    >>> url = '/' + project['name']
    >>> response = app.post(url, params=fields)
    >>> app.get('/')[0]['author']
    [u'jhammel']
    >>> fields = {'author': 'turing'}
    >>> response = app.post(url, params=fields)
    >>> sorted(app.get('/')[0]['author'])
    [u'jhammel', u'turing']

Now let's search for the project!::

    >>> authors = app.get('/author')
    >>> len(authors)
    2
    >>> authors['jhammel']
    [u'foo']
    >>> authors['turing']
    [u'foo']

Let's search for it a different way::

    >>> project = app.get('/')[0]
    >>> projects = app.get('/', params={'author': 'jhammel'})
    >>> newproject = projects[0]
    >>> newproject == project
    True

Just to show that the search is doing something::

    >>> app.get('/', params={'author': 'sauron'})
    []

Now lets add another project::
    
    >>> project2 = {'name': 'bar', 'description': 'a bar downtown', 'url': 'http://www.example.com'}
    >>> response = app.post('/new', params=project2)
    >>> projects = app.get('/')
    >>> len(projects)
    2
    >>> projects[0]['name']
    u'bar'
    >>> projects[1]['name']
    u'foo'
    >>> jhammels_projects = app.get('/', params={'author': 'jhammel'})
    >>> len(jhammels_projects)
    1
    >>> jhammels_projects[0]['name']
    u'foo'
    
Test search::

    >>> projects = app.get('/', params={'q': 'jhammel'})
    >>> len(projects)
    1
    >>> projects[0]['name']
    u'foo'
    >>> projects = app.get('/', params={'q': 'downtown'})
    >>> len(projects)
    1
    >>> projects[0]['name']
    u'bar'

Add some metadata. Make sure we see it::

    >>> url = '/bar'
    >>> response = app.post(url, {'author': 'turing'})
    >>> len(app.get())
    2
    >>> len(app.get('/', params={'author': 'jhammel'}))
    1
    >>> len(app.get('/', params={'author': 'turing'}))
    2
    >>> len(app.get('/', params={'q': 'turing'}))
    2
    >>> projects = app.get('/', params={'author': 'turing', 'q': 'downtown'})
    >>> len(projects)
    1
    >>> projects[0]['name'] 
    u'bar'

Add a third project, just for variety::

    >>> response = app.post('/new', params=dict(name='fleem', description='fleem in a building downtown', url='http://example.net'))
    >>> projects = app.get('/')
    >>> len(projects)
    3
    >>> [i['name'] for i in app.get('/', params=dict(q='downtown'))]
    [u'fleem', u'bar']
    >>> [i['name'] for i in app.get('/', params=dict(q='building'))]
    [u'fleem']
    
Delete some metadata::

    >>> response = app.post('/bar', params={'action': 'delete', 'author': 'turing'})
    >>> projects = app.get('/', params={'author': 'turing'})
    >>> len(projects)
    1
    >>> projects[0]['name']
    u'foo'
    >>> projects = app.get('/', params={'q': 'turing'})
    >>> len(projects)
    1
    >>> projects[0]['name']
    u'foo'

Delete a project::

    >>> response = app.post('/delete', params={'project': 'foo'})
    >>> len(app.get('/'))
    2
    >>> len(app.get('/', params={'author': 'jhammel'}))
    0
